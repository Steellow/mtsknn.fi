@tailwind base;
@tailwind components;
@tailwind utilities;

@layer base {
  ::selection {
    @apply bg-red-200;
  }
  pre code::selection,
  pre code br::selection,
  pre code del::selection,
  pre code ins::selection,
  pre code mark::selection,
  pre code span::selection {
    @apply bg-gray-700;
  }

  *:focus {
    /* `outline: 0;` would make the focus ring invisible in Windows's
     * high-contrast themes. See https://stackoverflow.com/a/52616313 */
    outline: transparent dotted 2px;

    @apply shadow-outline;
    box-decoration-break: clone;
  }

  h2,
  h3,
  h4 {
    /* Needed for the styling of anchor links (permalinks) inside headings */
    @apply relative;
  }
}

@layer components {
  @screen xl {
    .main-skip-link {
      margin-left: -100% !important;
    }
  }

  .prose > * {
    max-width: 65ch;
  }
  .prose > pre {
    @apply max-w-none;
  }

  .prose .list-none::before {
    content: none;
  }

  /* Need to use the tag name as well to override the `.prose a` selector */
  a.link {
    @apply duration-150 underline;
    text-decoration-color: theme('colors.red.500');
    text-decoration-thickness: 2px;
    transition-property: color, text-decoration-color;
  }
  a.link:hover {
    @apply text-red-600;
  }
  a.link:active {
    text-decoration-color: theme('colors.red.600');
  }
  h1 .link,
  h2 .link,
  h3 .link {
    text-decoration-thickness: 3px;
  }

  /* O'boy how difficult it was to find a solid technique for adding an external
   * link icon with these criteria:
   * - Doesn't wrap to the next line
   * - Doesn't make trailing punctuation wrap to the next line (e.g. a period
   *   right after the link text)
   * - Doesn't require modifying the HTML (i.e. I wanted a CSS-only solution)
   *
   * Luckily I found this underappreciated SO answer with a simple solution:
   * https://stackoverflow.com/a/38418279
   */
  .link.link-external::after {
    @apply bg-center bg-no-repeat;
    @apply ml-1; /* Spacing */
    @apply px-2; /* Sizing */

    /* `external-link` icon by Heroicons (https://heroicons.com/), MIT Licensed.
     * `%2364748b` = `#64748b` = `text-gray-500` */
    background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="%2364748b"><path d="M11 3a1 1 0 100 2h2.586l-6.293 6.293a1 1 0 101.414 1.414L15 6.414V9a1 1 0 102 0V4a1 1 0 00-1-1h-5z"/><path d="M5 5a2 2 0 00-2 2v8a2 2 0 002 2h8a2 2 0 002-2v-3a1 1 0 10-2 0v3H5V7h3a1 1 0 000-2H5z"/></svg>');

    /* `alt` and the second value of `content` are for screen readers. See e.g.
     * https://www.stefanjudis.com/today-i-learned/css-content-accepts-alternative-text/ */
    alt: '(external link)'; /* Supported by Safari */
    content: ''; /* Fallback */
    content: '' / '(external link)'; /* Supported by most but not FF or Safari */
  }

  h2 .link-anchor,
  h3 .link-anchor,
  h4 .link-anchor {
    @apply ml-3 text-gray-400;
  }
  .link-anchor svg {
    @apply inline;
    vertical-align: calc(-1 * theme('spacing.1'));
  }
  h2 .link-anchor svg {
    width: theme('spacing.6') !important;
  }
  h3 .link-anchor svg {
    width: theme('spacing.5') !important;
  }
  h4 .link-anchor svg {
    width: theme('spacing.4') !important;
  }
  @screen lg {
    h2 .link-anchor,
    h3 .link-anchor,
    h4 .link-anchor {
      @apply absolute top-0;
      left: calc(-1 * theme('spacing.2'));
    }
    h2 .link-anchor {
      @apply -ml-6 mt-1;
    }
    h3 .link-anchor {
      @apply -ml-5;
      margin-top: calc(theme('spacing.2') - 0.1rem);
    }
    h4 .link-anchor {
      @apply -ml-4 mt-1;
    }
  }
  @screen xl {
    h2 .link-anchor,
    h3 .link-anchor,
    h4 .link-anchor {
      left: calc(-1 * theme('spacing.3'));
    }
    h2 .link-anchor {
      @apply -ml-8;
    }
    h3 .link-anchor {
      @apply -ml-6;
    }
    h4 .link-anchor {
      @apply -ml-5;
    }
    h2 .link-anchor svg {
      width: theme('spacing.8') !important;
    }
    h3 .link-anchor svg {
      width: theme('spacing.6') !important;
    }
    h4 .link-anchor svg {
      width: theme('spacing.5') !important;
    }
  }

  .link.link-tag::before {
    @apply bg-bottom bg-no-repeat h-4 inline-block mr-1 w-4;
    content: '';
    vertical-align: -0.2rem;

    /* `hashtag` icon by Heroicons (https://heroicons.com/), MIT Licensed.
     * `%2364748b` = `#64748b` = `text-gray-500` */
    background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="%2364748b"><path fill-rule="evenodd" d="M9.243 3.03a1 1 0 01.727 1.213L9.53 6h2.94l.56-2.243a1 1 0 111.94.486L14.53 6H17a1 1 0 110 2h-2.97l-1 4H15a1 1 0 110 2h-2.47l-.56 2.242a1 1 0 11-1.94-.485L10.47 14H7.53l-.56 2.242a1 1 0 11-1.94-.485L5.47 14H3a1 1 0 110-2h2.97l1-4H5a1 1 0 110-2h2.47l.56-2.243a1 1 0 011.213-.727zM9.03 8l-1 4h2.938l1-4H9.031z" clip-rule="evenodd"/></svg>');
  }
  @screen xl {
    .link.link-tag::before {
      vertical-align: -0.15rem;
    }
  }

  pre {
    @apply -mx-6 sm:mx-0 sm:rounded-md;
  }
  pre code {
    @apply inline-block min-w-full;
  }

  /* Syntax highlighting colors borrowed from https://blog.tailwindcss.com. See:
   * - https://github.com/tailwindlabs/blog.tailwindcss.com/blob/39d37c/next.config.js#L8-L20
   * - https://github.com/tailwindlabs/blog.tailwindcss.com/blob/39d37c/tailwind.config.js#L42-L51
   *
   * (I added the `.token.url` selector to make Markdown snippets look better.)
   */
  .token.tag,
  .token.deleted,
  .token.boolean {
    color: #ff8383; /* red */
  }
  .token.attr-name {
    color: #ffe484; /* yellow */
  }
  .token.attr-value,
  .token.inserted,
  .token.string,
  .token.url {
    color: #b5f4a5; /* green */
  }
  .token.punctuation {
    @apply text-white;
  }
  .token.keyword {
    color: #d9a9ff; /* purple */
  }
  .token.string {
    color: #b5f4a5; /* green */
  }
  .token.function {
    color: #93ddfd; /* blue */
  }
  .token.comment {
    @apply italic;
    color: #9fa6b2; /* gray */
  }

  .highlight-line {
    @apply inline-block min-w-full px-4 xl:px-5;

    /* `<del>`, `<ins>`, `<mark>` default styles */
    @apply no-underline;
    color: inherit;
  }
  .highlight-line:empty::before {
    /* Enable highlighting empty lines */
    content: ' ';
  }
  .highlight-line-active {
    @apply bg-gray-700;
  }
  .highlight-line-add {
    @apply bg-green-900;
  }
  .highlight-line-remove {
    @apply bg-red-900;
  }
}
